name: Codex review on PRs

on:
  pull_request_target:
    types: [opened, reopened, synchronize, labeled, ready_for_review]
  workflow_dispatch:
    inputs:
      pr:
        description: "PR number to run @codex review on"
        required: true
        type: number

permissions:
  contents: read
  pull-requests: write
  issues: write

concurrency:
  group: codex-review-${{ github.event.pull_request.number || github.run_id }}
  cancel-in-progress: false

jobs:
  codex-on-pr:
    if: >
      github.event_name == 'pull_request_target' &&
      github.repository_owner == 'anpicci' &&
      !github.event.pull_request.draft
    runs-on: ubuntu-latest
    steps:
      - name: Debug event context
        run: |
          echo "Event: ${{ github.event_name }}"
          echo "Repo owner: ${{ github.repository_owner }}"
          echo "PR #: ${{ github.event.pull_request.number }}"
          echo "Labels: ${{ toJson(github.event.pull_request.labels) }}"

      - name: Check for 'codex' label
        id: guard
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR: ${{ github.event.pull_request.number }}
        run: |
          if gh pr view "$PR" --json labels -q '.labels[].name' | grep -qx codex; then
            echo "run=true" >> "$GITHUB_OUTPUT"
          else
            echo "run=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Post '@codex review'
        if: steps.guard.outputs.run == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR: ${{ github.event.pull_request.number }}
        run: |
          gh pr comment "$PR" --body "@codex review"

      - name: Skip note
        if: steps.guard.outputs.run != 'true'
        run: echo "Skipping: PR lacks 'codex' label."

  codex-dispatch:
    if: github.event_name == 'workflow_dispatch' && github.repository_owner == 'anpicci'
    runs-on: ubuntu-latest
    steps:
      - name: Post '@codex review' (manual)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR: ${{ inputs.pr }}
        run: |
          gh pr comment "$PR" --body "@codex review"
