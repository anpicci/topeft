name: Codex PR Review

on:
  pull_request_target:
    types: [opened, reopened, synchronize, labeled, ready_for_review]

  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number on which to post @codex review'
        required: true

permissions:
  issues: write
  pull-requests: write

jobs:
  codex-review:
    # Repo-guard: execute only on anpicci/topeft
    if: >
      (github.repository == 'anpicci/topeft') &&
      (github.event_name == 'workflow_dispatch' || github.event.pull_request.base.ref != 'master')
    runs-on: ubuntu-latest
    concurrency:
      group: codex-review-${{ github.repository }}-${{ github.event.pull_request.number || github.event.inputs.pr_number || 'manual' }}
      cancel-in-progress: false

    steps:
      - name: Post @codex review (auto su PR)
        if: ${{ github.event_name == 'pull_request_target' }}
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const hasLabel = (pr.labels || []).some(l => (l.name || '').toLowerCase() === 'codex');
            if (!hasLabel) { core.info('Label "codex" non presente: skip.'); return; }
            if (pr.base.ref === 'master') { core.info('Base = master: policy → skip.'); return; }
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              body: '@codex review'
            });
            core.info('Commento "@codex review" postato.');

      - name: Post @codex review (manual)
        if: ${{ github.event_name == 'workflow_dispatch' }}
        uses: actions/github-script@v7
        with:
          script: |
            const pr_number = parseInt(core.getInput('pr_number'),10);
            const {owner, repo} = context.repo;
            const { data: pr } = await github.rest.pulls.get({ owner, repo, pull_number: pr_number });
            if (pr.base.ref === 'master') { core.info('Base = master: policy → skip.'); return; }
            const hasLabel = (pr.labels || []).some(l => (l.name || '').toLowerCase() === 'codex');
            if (!hasLabel) { core.info('Label "codex" non presente: skip.'); return; }
            await github.rest.issues.createComment({ owner, repo, issue_number: pr_number, body: '@codex review' });
            core.info('Comment "@codex review" posted (manual).')
