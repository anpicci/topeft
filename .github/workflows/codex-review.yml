# .github/workflows/codex-review.yml
name: Codex review on PRs

on:
  pull_request_target:
    types: [opened, reopened, synchronize, ready_for_review, labeled]
  workflow_dispatch: {}

permissions:
  contents: read
  pull-requests: write
  issues: write

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: false

jobs:
  trigger-codex-review:
    # Repo guard: attivo solo sul tuo fork (evita upstream)
    # Label guard: serve la label "codex"
    # Niente draft
    if: >
      github.repository_owner == 'anpicci' &&
      (!github.event.pull_request.draft) &&
      contains(github.event.pull_request.labels.*.name, 'codex')
    runs-on: ubuntu-latest

    steps:
      - name: Debug context
        run: |
          echo "Repo: ${{ github.repository }}"
          echo "Owner: ${{ github.repository_owner }}"
          echo "Event: ${{ github.event_name }}"
          echo "Labels: ${{ toJson(github.event.pull_request.labels.*.name) }}"

      - name: Comment "@codex review" (deduplicated)
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { owner, repo, number } = context.issue;

            // evita duplicati: controlla se esiste già un commento identico recente
            const comments = await github.paginate(
              github.rest.issues.listComments,
              { owner, repo, issue_number: number, per_page: 100 }
            );
            const already = comments.some(c =>
              c.user?.type === 'Bot' && c.body?.trim() === '@codex review'
            );
            if (already) {
              core.info('Commento "@codex review" già presente: salto.');
              return;
            }

            await github.rest.issues.createComment({
              owner, repo, issue_number: number, body: '@codex review'
            });
            core.info(`Commentato PR #${number}.`);
